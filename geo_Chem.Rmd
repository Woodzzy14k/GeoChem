---
title: "GeoChem Final Project"
author: "Alex Wood"
date: "May 1, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
```

#bring in Beisner et.al data from USGS repository
```{r}
gcData <- read_csv(here::here("gcData.csv"), 
                   col_types = cols(`Alpha_ radioactivity_( picocuries/liter)` = col_double(), 
                                    `Aluminum_(ug/L)` = col_double(), 
                                    `Antimony_(ug/L)` = col_double(), 
                                    `Barium_(ug/L)` = col_double(), `Beryllium_(ug/L)` = col_double(), 
                                    `Bicarbonate_(ug/L)` = col_double(), 
                                    `Boron_(ug/L)` = col_double(), `Cadmium_(ug/L)` = col_double(), 
                                    `Chromium_(ug/L)` = col_double(), 
                                    `Cobalt_(ug/L)` = col_double(), `Copper_(ug/L)` = col_double(), 
                                    `DO_m/L` = col_double(), Date = col_character(), 
                                    `Fluoride_(ug/L)` = col_double(), 
                                    `Iron_(ug/L)` = col_double(), `Lead_(ug/L)` = col_double(), 
                                    `Manganese_(ug/L)` = col_double(), 
                                    `Molybdenum_(ug/L)` = col_double(), 
                                    `Nickel_(ug/L)` = col_double(), `P_(mmHg)` = col_double(), 
                                    `Q _(gpm)` = col_double(), `Radium-226_(picocuries/liter)` = col_double(), 
                                    `Radium-228_(picocuries/liter)` = col_double(), 
                                    `SC_uS/cm` = col_double(), `Selenium_(ug/L)` = col_double(), 
                                    `Strontium_(ug/L)` = col_double(), 
                                    `Thallium_(ug/L)` = col_double(), 
                                    `Uranium-235_(picocuries/liter)` = col_double(), 
                                    `Vanadium_(ug/L)` = col_double(), 
                                    X55 = col_skip(), `Zinc_(ug/L)` = col_double(), 
                                    `beta_radioactivity_(picocuries/liter)` = col_double(), 
                                    ph = col_double()))
#convert to data.frame
gcData=as.data.frame(gcData)
#fix dates
gcData$Date=as.Date(gcData$Date, "%m/%d/%Y")

gc=gcData

```
#make into matrix
```{r}
#get ride of characters and time
gcData=gcData[,-1]
gcData=gcData[,-1]
gcData=gcData[,-1]
gcData=gcData[,-1]


gcData


geoMatrix=matrix(as.numeric(unlist(gcData)), nrow=nrow(gcData))




#replace all non-finite values with 0
geoMatrix[!rowSums(!is.finite(geoMatrix)),]
geoMatrix[!is.finite(geoMatrix)] <- 0
#check
is.na(geoMatrix)

```
#PCA
```{r}
#Now we want to calculate the covariance matrix. First need to make a new version of this matrix such that each column has Center the data so that the mean of each column is 0 scale() is a useful function to do this, but check afterward to make sure you'be done it right

#subract that mean and center it on 0
x=scale(geoMatrix, center=TRUE, scale=TRUE)

x[!rowSums(!is.finite(x)),]
x[!is.finite(x)] <- 0


# 1e. OK - now use linear algebra to calculate your covariance matrix. Are the values consistent with the plots in 1a?

#covariance matrix
coGeo=(t(x)%*%x/(nrow(x)-1))
head(coGeo)

#correlation is standard covariance!
head(cor(geoMatrix))


# 1f. Now we want to try to find a matrix ("P") (our EOFs) that we can multiply by our original matrix to turn it into orthogonal indices (our PCs).

# To do so, use svd() on your covariance matrix.





out=svd(coGeo)

names(out)

save4l8er=diag(out$d)

sum(save4l8er)

print(save4l8er)

#project data onto new axes
PCs=(x%*%out$v)
#14 of them
dim(PCs)
cov(PCs)


#total covariance
sum(out$d)
#52 because it is normalized

#how much of each dataset variability is represented by each PC
fracVariance=out$d/sum(out$d)
fracVariance
dim(fracVariance)

#  [1] 2.265261e-01 1.232844e-01 9.086059e-02 8.984507e-02 5.436577e-02 5.097694e-02 4.523706e-02
#  [8] 3.768298e-02 3.407570e-02 3.155706e-02 2.867213e-02 2.317711e-02 2.195093e-02 1.987993e-02
# [15] 1.503582e-02 1.404793e-02 1.268982e-02 1.204202e-02 9.690446e-03 9.573916e-03 8.309471e-03
# [22] 6.550347e-03 5.676916e-03 5.064956e-03 4.500850e-03 3.608303e-03 3.081540e-03 2.230138e-03
# [29] 2.072954e-03 1.577602e-03 1.302185e-03 1.263198e-03 9.135126e-04 6.608740e-04 6.337546e-04
# [36] 4.479987e-04 2.969902e-04 2.757148e-04 1.237155e-04 6.833702e-05 5.499831e-05 3.788179e-05
# [43] 2.364047e-05 1.785524e-05 1.464408e-05 1.084642e-05 7.404622e-06 1.227778e-06 3.249740e-07
# [50] 8.419284e-08

#save for later one
sum(save4l8er)
#50
out$d/sum(out$d)

```
```{r}
#make x the same as pcas...there is 50 of them!
x1=c(1:50)


ggplot()+geom_point(aes(x=x1, y=fracVariance))+ggtitle("Fraction of Variance in Each PCA")+xlab("PCA")+ylab("Percent Variance")


```
```{r}
head(gcData)



#data frame with the original data, and PCs
df = cbind(as.data.frame(PCs),gcData[1:nrow(x),]) 
df=cbind(df, gc$Unit)
dim(df)
#renamed unit
names(df)[101]="Unit"

dim(df)
dim(df2)

#and eigenvectors with names
df2 = cbind(as.data.frame(out$v),names(gcData[,-c(5)]))


gc=gc[,-1]
gc=gc[,-2]
gc=gc[,-2]
names(gc)


df2 = cbind(as.data.frame(out$v),names(gcData))
df2

dim(out$v)
dim(gcData)

gcData=gcData[-53,]
gcData=gcData[-52,]
gcData=gcData[-51,]

names(df2)[51]="names"


#as a data.frame, it converts them to v1, v2 and v3, etc.. 

#and make an awesome plot, we're going to compare PC1 and PC2



ggplot(df, aes(x = V1, y= V2))+geom_point(aes(colour=Unit),size=6)+
  #first just plotting points and colouring them by the cut
  
  geom_hline(yintercept=0)+geom_vline(xintercept=0)+
  
  #then we'll plot some 0 lines for our reference
  coord_fixed(xlim=c(-3,3),ylim=c(-2,3))+
  
  #and set the scale
  geom_segment(data=df2,aes(x=0,y=0,xend = V1*arrowScale, yend = V2*arrowScale))+
  
  #Now we'll add lines that correspond to our eigen vectors
  geom_text(data=df2,aes(x = V1*arrowScale, y = V2*arrowScale,label=names))
  #and label those lines

plot=ggplot(df, aes(x = V1, y= V2))+geom_point(aes(colour=Unit),size=6)+
  #first just plotting points and colouring them by the cut
  
  geom_hline(yintercept=0)+geom_vline(xintercept=0)+
  
  #then we'll plot some 0 lines for our reference
  coord_fixed(xlim=c(-3,3),ylim=c(-2,3))+
  
  #and set the scale
  geom_segment(data=df2,aes(x=0,y=0,xend = V1*arrowScale, yend = V2*arrowScale))+
  
  #Now we'll add lines that correspond to our eigen vectors
  geom_text(data=df2,aes(x = V1*arrowScale, y = V2*arrowScale,label=names))
  #and label those lines

ggsave("plot.jpg", width = 15, height = 15, units = "in")

```
#now look at spring name
```{r}
#bring data into to make it less confusing

gcData <- read_csv(here::here("gcData.csv"), 
                   col_types = cols(`Alpha_ radioactivity_( picocuries/liter)` = col_double(), 
                                    `Aluminum_(ug/L)` = col_double(), 
                                    `Antimony_(ug/L)` = col_double(), 
                                    `Barium_(ug/L)` = col_double(), `Beryllium_(ug/L)` = col_double(), 
                                    `Bicarbonate_(ug/L)` = col_double(), 
                                    `Boron_(ug/L)` = col_double(), `Cadmium_(ug/L)` = col_double(), 
                                    `Chromium_(ug/L)` = col_double(), 
                                    `Cobalt_(ug/L)` = col_double(), `Copper_(ug/L)` = col_double(), 
                                    `DO_m/L` = col_double(), Date = col_character(), 
                                    `Fluoride_(ug/L)` = col_double(), 
                                    `Iron_(ug/L)` = col_double(), `Lead_(ug/L)` = col_double(), 
                                    `Manganese_(ug/L)` = col_double(), 
                                    `Molybdenum_(ug/L)` = col_double(), 
                                    `Nickel_(ug/L)` = col_double(), `P_(mmHg)` = col_double(), 
                                    `Q _(gpm)` = col_double(), `Radium-226_(picocuries/liter)` = col_double(), 
                                    `Radium-228_(picocuries/liter)` = col_double(), 
                                    `SC_uS/cm` = col_double(), `Selenium_(ug/L)` = col_double(), 
                                    `Strontium_(ug/L)` = col_double(), 
                                    `Thallium_(ug/L)` = col_double(), 
                                    `Uranium-235_(picocuries/liter)` = col_double(), 
                                    `Vanadium_(ug/L)` = col_double(), 
                                    X55 = col_skip(), `Zinc_(ug/L)` = col_double(), 
                                    `beta_radioactivity_(picocuries/liter)` = col_double(), 
                                    ph = col_double()))

#convert to data.frame
gcData=as.data.frame(gcData)
#fix dates
gcData$Date=as.Date(gcData$Date, "%m/%d/%Y")

gc2=gcData


gcData=gcData[,-1]
gcData=gcData[,-1]
gcData=gcData[,-1]
gcData=gcData[,-1]


#data frame with the original data, and PCs
df = cbind(as.data.frame(PCs),gcData[1:nrow(x),]) 
df=cbind(df, gc2$Spring)
dim(df)
#renamed unit
names(df)[101]="Spring"

dim(df)
dim(df2)

#and eigenvectors with names
gc=gc[,-1]
gc=gc[,-2]
gc=gc[,-2]
names(gc)


df2 = cbind(as.data.frame(out$v),names(gcData))

dim(out$v)
dim(gcData)

gcData=gcData[-53,]
gcData=gcData[-52,]
gcData=gcData[-51,]

names(df2)[51]="names"


#as a data.frame, it converts them to v1, v2 and v3, etc.. 

#and make an awesome plot, we're going to compare PC1 and PC2

arrowScale=5

ggplot(df, aes(x = V1, y= V2))+geom_point(aes(colour=Spring),size=6)+
  #first just plotting points and colouring them by the cut
  
  geom_hline(yintercept=0)+geom_vline(xintercept=0)+
  
  #then we'll plot some 0 lines for our reference
  coord_fixed(xlim=c(-3,3),ylim=c(-2,3))+
  
  #and set the scale
  geom_segment(data=df2,aes(x=0,y=0,xend = V1*arrowScale, yend = V2*arrowScale))+
  
  #Now we'll add lines that correspond to our eigen vectors
  geom_text(data=df2,aes(x = V1*arrowScale, y = V2*arrowScale,label=names))
  #and label those lines

plot2=ggplot(df, aes(x = V1, y= V2))+geom_point(aes(colour=Spring),size=6)+
  #first just plotting points and colouring them by the cut
  
  geom_hline(yintercept=0)+geom_vline(xintercept=0)+
  
  #then we'll plot some 0 lines for our reference
  coord_fixed(xlim=c(-3,3),ylim=c(-2,3))+
  
  #and set the scale
  geom_segment(data=df2,aes(x=0,y=0,xend = V1*arrowScale, yend = V2*arrowScale))+
  
  #Now we'll add lines that correspond to our eigen vectors
  geom_text(data=df2,aes(x = V1*arrowScale, y = V2*arrowScale,label=names))
  #and label those lines

ggsave("plot2.jpg", width = 15, height = 15, units = "in")


```

#more data

```{r}
gcData

ggplot(gcData, aes(x=(delta_O18_( per_mil)), y=(Delta_D_(per_mil)), color=factor(ph)))
```




